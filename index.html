<!-- ======= CSS ======= -->
<style>
.acc-wrap{
  background:#fff; padding:15px; border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.15); margin-bottom:20px; max-width:100%;
}
.acc-wrap h3{text-align:center; color:#222; margin-top:0;}
#searchInput{width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;}
.table-wrap{overflow-x:auto; width:100%; border-radius:10px;}
.accounts-table{width:100%; border-collapse:collapse; min-width:800px;}
.accounts-table thead{background:#2563eb; color:white; cursor:pointer;}
.accounts-table th, .accounts-table td{padding:10px; border-bottom:1px solid #e5e7eb; font-size:14px;}
.accounts-table tr:hover{background:#f3f4f6;}
.btn{padding:6px 10px; border:none; border-radius:6px; cursor:pointer; color:#fff; margin:2px;}
.edit-btn{background:#16a34a;} .delete-btn{background:#dc2626;} .page-btn{background:#2563eb; font-weight:bold;}
.tag-email{color:#1d4ed8; font-weight:bold;} .tag-username{color:#16a34a; font-weight:bold;} .tag-other{color:#d97706; font-weight:bold;}
/* Modal */
.modal-bg{position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:9999;}
.modal-box{background:#fff; width:90%; max-width:400px; padding:20px; border-radius:12px; animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0; transform:scale(.85);} to{opacity:1; transform:scale(1);}}
.modal-box input{width:100%; margin:6px 0; padding:8px; border:1px solid #ccc; border-radius:6px;}
.modal-box button{width:100%; padding:10px; margin-top:10px; border:none; border-radius:6px; font-weight:bold;}
.modal-save{background:#2563eb; color:white;} .modal-cancel{background:#dc2626; color:white;}
/* Floating add button */
.floating-btn{
  position:fixed; bottom:30px; right:30px; background:#2563eb; color:white; padding:15px; border-radius:50%; font-size:24px; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,0.3);
  z-index:999;
}
</style>

<!-- ======= HTML ======= -->
<div class="acc-wrap">
<h3>Accounts Dashboard</h3>

<input type="text" id="searchInput" placeholder="Search Name, Username, Email...">
<button id="exportCSV" style="margin-bottom:10px; padding:6px 10px;">Export CSV</button>

<hr>
<div class="table-wrap">
  <table class="accounts-table">
    <thead><tr id="tableHead"></tr></thead>
    <tbody id="accountsBody"><tr><td colspan="100">Loading...</td></tr></tbody>
  </table>
</div>

<div style="margin-top:10px; text-align:center;">
  <button class="page-btn" id="prevPage">Prev</button>
  <span id="pageInfo" style="margin:0 10px;"></span>
  <button class="page-btn" id="nextPage">Next</button>
</div>
</div>

<!-- Floating add button -->
<div class="floating-btn" id="openAddBtn">+</div>

<!-- Add/Edit Modal -->
<div class="modal-bg" id="modalForm">
  <div class="modal-box">
    <h3 id="modalTitle">Add Account</h3>
    <div id="modalInputs"></div>
    <button class="modal-save" id="saveBtn">Save</button>
    <button class="modal-cancel" id="closeModalBtn">Cancel</button>
  </div>
</div>

<!-- ======= JS ======= -->
<script>
const apiURL="https://script.google.com/macros/s/AKfycbwBahiOMEmk2e77z2BhFNUy4bA-TpPzqZ9NPaG2kN_OrYYvIG2MyhLfpSh8RIHKL4Z3vQ/exec";
const HEADERS=["Name","Username","Email","Password","2FA Key","Phone","Recovery","Notes"];
const tableHead=document.getElementById("tableHead");
const tbody=document.getElementById("accountsBody");
const modal=document.getElementById("modalForm");
const modalInputs=document.getElementById("modalInputs");
const modalTitle=document.getElementById("modalTitle");
let accountsData=[], currentPage=1, pageSize=5;
let EDIT_USERNAME=""; // track username for edit
let isEdit=false;

// ===== Table Headers =====
HEADERS.forEach((h,i)=>{
  const th=document.createElement("th");
  th.textContent=h;
  th.onclick=()=>sortTable(i);
  tableHead.appendChild(th);
});
const actTh=document.createElement("th"); actTh.textContent="Actions"; tableHead.appendChild(actTh);

// ===== Fetch Accounts =====
async function safeJSON(res){try{return JSON.parse(await res.text());}catch{return [];}}

async function fetchAccounts(){
  accountsData=await safeJSON(await fetch(apiURL));
  renderTable();
}

// ===== Render Table =====
function renderTable(){
  let data=accountsData.slice();
  const q=document.getElementById("searchInput").value.toLowerCase();
  if(q) data=data.filter(r=>["Name","Username","Email"].some(k=>(r[k]||"").toLowerCase().includes(q)));
  const totalPages=Math.ceil(data.length/pageSize);
  if(currentPage>totalPages) currentPage=totalPages||1;
  if(currentPage<1) currentPage=1;
  const start=(currentPage-1)*pageSize; const end=start+pageSize;
  const pageData=data.slice(start,end);
  document.getElementById("pageInfo").textContent=`Page ${currentPage} of ${totalPages||1}`;
  if(!pageData.length){tbody.innerHTML=`<tr><td colspan="${HEADERS.length+1}">No data</td></tr>`; return;}
  tbody.innerHTML=pageData.map((r,i)=>{
    const cols=HEADERS.map(h=>{
      let cls="tag-other";
      if(h.toLowerCase().includes("email")) cls="tag-email";
      if(h.toLowerCase().includes("username")) cls="tag-username";
      return `<td class="${cls}">${r[h]||""}</td>`;
    }).join('');
    return `<tr>${cols}<td>
      <button class="btn edit-btn" onclick="openEdit(${i+start})">Edit</button>
      <button class="btn delete-btn" onclick="deleteAccount('${r.Username}')">Delete</button>
    </td></tr>`;
  }).join('');
}

// ===== Sorting =====
function sortTable(n){
  accountsData.sort((a,b)=> (a[HEADERS[n]]||"").localeCompare(b[HEADERS[n]]||""));
  renderTable();
}

// ===== Pagination =====
document.getElementById("prevPage").onclick=()=>{currentPage--; renderTable();}
document.getElementById("nextPage").onclick=()=>{currentPage++; renderTable();}

// ===== Search =====
document.getElementById("searchInput").addEventListener("input",()=>{currentPage=1; renderTable();});

// ===== Export CSV =====
document.getElementById("exportCSV").onclick=()=>{
  let csv=HEADERS.join(",")+"\n";
  accountsData.forEach(r=>{
    csv+=HEADERS.map(h=>`"${(r[h]||"").replace(/"/g,'""')}"`).join(",")+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="accounts.csv"; a.click(); URL.revokeObjectURL(url);
};

// ===== Modal Controls =====
function openModal(){modal.style.display="flex";}
function closeModal(){modal.style.display="none"; isEdit=false;}
document.getElementById("closeModalBtn").onclick=closeModal;

// ===== Floating Add Account =====
document.getElementById("openAddBtn").onclick=()=>{
  isEdit=false;
  modalTitle.textContent="Add Account";
  modalInputs.innerHTML="";
  HEADERS.forEach(h=>{
    const inp=document.createElement("input"); inp.id="f_"+h.replace(/ /g,''); inp.placeholder=h;
    if(h==="Name"||h==="Username") inp.required=true;
    modalInputs.appendChild(inp);
  });
  openModal();
};

// ===== Save Button (Add/Edit) =====
document.getElementById("saveBtn").onclick=()=>{
  const payload={};
  HEADERS.forEach(h=>{
    const val=(isEdit?document.getElementById("e_"+h.replace(/ /g,'')) : document.getElementById("f_"+h.replace(/ /g,''))).value.trim();
    payload[h]=val;
  });
  if(isEdit){payload._edit=true; payload.Username_old=EDIT_USERNAME;}
  fetch(apiURL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  alert(isEdit?"Updated!":"Saved!");
  closeModal(); setTimeout(fetchAccounts,900);
};

// ===== Edit Modal =====
function openEdit(i){
  isEdit=true;
  const row=accountsData[i]; EDIT_USERNAME=row.Username;
  modalTitle.textContent="Edit Account";
  modalInputs.innerHTML="";
  HEADERS.forEach(h=>{
    const inp=document.createElement("input"); inp.id="e_"+h.replace(/ /g,''); inp.value=row[h]||""; modalInputs.appendChild(inp);
  });
  openModal();
}

// ===== Delete =====
function deleteAccount(username){
  if(!confirm("Delete this?")) return;
  fetch(apiURL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({Username:username,_delete:true})});
  alert("Deleted!"); setTimeout(fetchAccounts,900);
}

// ===== Initialize =====
fetchAccounts();
</script>
